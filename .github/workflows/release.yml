name: Release

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:
        inputs:
            version:
                description: "Version to release (e.g., 0.1.0)"
                required: true

jobs:
    build-debs:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                include:
                    - ros_distro: humble
                      os_version: "22.04"
                    - ros_distro: kilted
                      os_version: "24.04"

        container:
            image: ros:${{ matrix.ros_distro }}-ros-base

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install dependencies
              run: |
                  apt-get update
                  apt-get install -y wget dpkg-dev

                  # Install wujihandcpp SDK
                  wget -q https://github.com/wuji-technology/wujihandpy/releases/download/v1.4.0/wujihandcpp-1.4.0-amd64.deb
                  dpkg -i --force-overwrite wujihandcpp-1.4.0-amd64.deb || true
                  apt-get install -f -y

                  # Install ROS dependencies
                  apt-get install -y \
                    ros-${{ matrix.ros_distro }}-sensor-msgs \
                    ros-${{ matrix.ros_distro }}-std-msgs \
                    ros-${{ matrix.ros_distro }}-robot-state-publisher

            - name: Build deb package
              run: |
                  chmod +x build_deb.sh
                  ./build_deb.sh ${{ matrix.ros_distro }}

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ros-${{ matrix.ros_distro }}-wujihand-deb
                  path: ros-${{ matrix.ros_distro }}-wujihand_*.deb

    release:
        needs: build-debs
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/')

        steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: List artifacts
              run: find artifacts -name "*.deb" -type f

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  files: artifacts/**/*.deb
                  generate_release_notes: true
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
